#--------------------------------------------------------------
# Deployment Workflow with Manual Approval
#--------------------------------------------------------------
# This workflow handles the apply stage with environment protection
# GitHub Environments provide manual approval gates
#--------------------------------------------------------------

name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy

env:
  TF_VERSION: '1.6.0'

jobs:
#--------------------------------------------------------------
# DEV DEPLOYMENT
#--------------------------------------------------------------
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.environment == 'dev' }}
    environment:
      name: development
      url: https://dev.morpheus.local
    defaults:
      run:
        working-directory: terraform/environments/dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'apply' }}
        run: |
          echo "Applying Terraform configuration to DEV..."
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan
          terraform output -json > outputs.json

      - name: Terraform Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "WARNING: Destroying DEV infrastructure..."
          terraform destroy -auto-approve

      - name: Upload Outputs
        if: ${{ github.event.inputs.action == 'apply' }}
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-dev
          path: terraform/environments/dev/outputs.json
          retention-days: 30

  configure-dev:
    name: Configure Dev (Ansible)
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: ${{ github.event.inputs.environment == 'dev' && github.event.inputs.action == 'apply' }}
    environment:
      name: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible

      - name: Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs-dev
          path: ./outputs

      - name: Run Ansible Configuration
        working-directory: ansible
        run: |
          echo "Running Ansible configuration for DEV..."
          echo "In production, this would use dynamic inventory from Terraform outputs"
          ansible-playbook --syntax-check playbooks/site.yml
          # Real execution would be:
          # ansible-playbook -i inventory/dev playbooks/site.yml -e "env=dev"
          echo "Ansible configuration complete for DEV"

#--------------------------------------------------------------
# PROD DEPLOYMENT
#--------------------------------------------------------------
  deploy-prod:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.environment == 'prod' }}
    environment:
      name: production
      url: https://prod.morpheus.local
    defaults:
      run:
        working-directory: terraform/environments/prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'apply' }}
        run: |
          echo "============================================"
          echo "  PRODUCTION DEPLOYMENT"
          echo "============================================"
          echo "Applying Terraform configuration to PROD..."
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan
          terraform output -json > outputs.json

      - name: Terraform Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "============================================"
          echo "  WARNING: DESTROYING PRODUCTION!"
          echo "============================================"
          terraform destroy -auto-approve

      - name: Upload Outputs
        if: ${{ github.event.inputs.action == 'apply' }}
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-prod
          path: terraform/environments/prod/outputs.json
          retention-days: 30

  configure-prod:
    name: Configure Prod (Ansible)
    runs-on: ubuntu-latest
    needs: deploy-prod
    if: ${{ github.event.inputs.environment == 'prod' && github.event.inputs.action == 'apply' }}
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible

      - name: Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs-prod
          path: ./outputs

      - name: Run Ansible Configuration
        working-directory: ansible
        run: |
          echo "============================================"
          echo "  PRODUCTION ANSIBLE CONFIGURATION"
          echo "============================================"
          echo "Running Ansible configuration for PROD..."
          ansible-playbook --syntax-check playbooks/site.yml
          # Real execution would be:
          # ansible-playbook -i inventory/prod playbooks/site.yml -e "env=prod"
          echo "Ansible configuration complete for PROD"
